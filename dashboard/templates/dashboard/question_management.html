{% extends 'dashboard/layouts/base.html' %}
{% load static %}

{% block title %}Manajemen Bank Soal{% endblock %}
{% block page_title %}Manajemen Bank Soal{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-1">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-lg font-semibold mb-4">Tambah Soal Baru</h2>
            {% if messages %}{% for message in messages %}
            <div class="p-4 mb-4 rounded-md {% if message.tags == 'success' %} bg-green-100 text-green-700 {% elif message.tags == 'error' %} bg-red-100 text-red-700 {% else %} bg-yellow-100 text-yellow-700 {% endif %}">
                {{ message }}
            </div>
            {% endfor %}{% endif %}
            <form method="POST" class="space-y-4" enctype="multipart/form-data">
                {% csrf_token %}
                {% for field in form %}
                <div class="mb-4" id="div_id_{{ field.name }}">
                    <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}<p class="mt-1 text-xs text-gray-500">{{ field.help_text|safe }}</p>{% endif %}
                    {% for error in field.errors %}<p class="mt-1 text-xs text-red-600">{{ error }}</p>{% endfor %}
                </div>
                {% endfor %}
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Tambah Soal</button>
            </form>
        </div>
    </div>

    <div class="lg:col-span-2">
        <div class="bg-white p-6 rounded-lg shadow-md" x-data="{ openMataPelajarans: [] }">
            <h2 class="text-lg font-semibold mb-4">Bank Soal</h2>

            <div class="space-y-3">
                {% for MataPelajaran, questions_in_MataPelajaran in grouped_questions.items %}
                <div class="border border-gray-200 rounded-lg">
                    <div class="p-4 flex justify-between items-center">
                        <button @click="openMataPelajarans.includes({{ MataPelajaran.pk }}) ? openMataPelajarans = openMataPelajarans.filter(id => id !== {{ MataPelajaran.pk }}) : openMataPelajarans.push({{ MataPelajaran.pk }})" 
                                class="flex-1 flex justify-between items-center text-left hover:bg-gray-50/50 rounded-md -m-2 p-2">
                            <div class="font-bold text-lg text-gray-800">
                                {{ MataPelajaran.name }} 
                                <span class="ml-2 text-sm font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded-full">{{ questions_in_MataPelajaran|length }} Soal</span>
                            </div>
                            <i class="ph ph-caret-down text-xl transition-transform" :class="{'rotate-180': openMataPelajarans.includes({{ MataPelajaran.pk }})}"></i>
                        </button>
                        <button onclick="document.getElementById('import-modal-{{ MataPelajaran.pk }}').classList.remove('hidden')" class="ml-4 bg-blue-500 text-white py-1 px-3 rounded-md text-xs hover:bg-blue-600 flex items-center">
                            <i class="ph ph-upload-simple mr-1"></i> Import
                        </button>
                    </div>

                    <div x-show="openMataPelajarans.includes({{ MataPelajaran.pk }})" x-transition class="p-4 border-t border-gray-200 bg-gray-50/50">
                        <div class="space-y-4">
                            {% for q in questions_in_MataPelajaran %}
                            <div class="border bg-white border-gray-200 rounded-lg p-5">
                                <div class="flex justify-between items-start mb-3">
                                    <p class="font-bold text-gray-800">Soal #{{ forloop.counter }} - <span class="font-normal text-gray-600">{{ q.get_question_type_display }}</span></p>
                                    <div class="flex items-center space-x-4">
                                        <a href="{% url 'question_edit' q.pk %}" class="text-gray-500 hover:text-indigo-600" title="Edit Soal"><i class="ph ph-pencil-simple text-xl"></i></a>
                                        <a href="{% url 'question_delete' q.pk %}" class="text-gray-500 hover:text-red-600" title="Hapus Soal"><i class="ph ph-trash text-xl"></i></a>
                                    </div>
                                </div>
                                <div class="text-gray-700 leading-relaxed mb-4 prose max-w-none">{{ q.question_text|safe }}</div>
                                 {% if q.image %}
                                 <div class="my-4">
                                 <img src="{{ q.image.url }}" alt="Gambar Soal" class="max-w-md rounded-lg shadow-md border">
                                 </div>
                                 {% endif %}
                                 {% if q.question_type == 'PILIHAN_GANDA' and q.options %}
                                 <div class="space-y-2 mb-4">
                                    {% for key, value in q.options.items %}
                                    <div class="flex items-center p-3 rounded-md {% if key == q.correct_answer %}bg-green-100 border border-green-300{% else %}bg-gray-100{% endif %}">
                                        <span class="font-bold mr-3">{{ key }}.</span>
                                        <span>{{ value }}</span>
                                        {% if key == q.correct_answer %}<i class="ph-bold ph-check-circle text-green-600 ml-auto text-xl" title="Jawaban Benar"></i>{% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="flex items-center space-x-3 text-sm text-gray-500 pt-3 border-t">
                                    <span class="bg-gray-200 text-gray-800 px-2 py-1 rounded-full font-medium">Level: {{ q.get_difficulty_display }}</span>
                                    <span class="bg-gray-200 text-gray-800 px-2 py-1 rounded-full font-medium">Bobot: {{ q.weight }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-12 border-2 border-dashed rounded-lg">
                    <p class="text-gray-500">Belum ada soal di bank soal.</p>
                    <p class="text-sm text-gray-400 mt-1">Gunakan form di sebelah kiri untuk membuat soal pertama.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% for MataPelajaran, questions_in_MataPelajaran in grouped_questions.items %}
<div id="import-modal-{{ MataPelajaran.pk }}" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
    <div class="relative bg-white rounded-lg shadow-xl w-full max-w-lg mx-auto p-6">
        <div class="flex justify-between items-center pb-3 border-b">
            <h3 class="text-xl font-semibold text-gray-800">Import Soal untuk <span class="text-blue-600">{{ MataPelajaran.name }}</span></h3>
            <button onclick="document.getElementById('import-modal-{{ MataPelajaran.pk }}').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="ph-bold ph-x text-2xl"></i></button>
        </div>
        <div class="mt-5">
            <p class="text-sm text-gray-600 mb-4">Pilih file Word (.docx) yang akan diimpor ke dalam bank soal mata pelajaran ini.</p>
            <form action="{% url 'question_import_for_MataPelajaran' MataPelajaran.pk %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="word_file" required accept=".docx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer mb-5"/>
                <div class="mt-6 flex flex-col sm:flex-row-reverse gap-3">
                    <button type="submit" class="w-full sm:w-auto inline-flex justify-center rounded-md shadow-sm px-6 py-2 bg-blue-600 font-medium text-white hover:bg-blue-700">Upload dan Import</button>
                    <button type="button" onclick="document.getElementById('import-modal-{{ MataPelajaran.pk }}').classList.add('hidden')" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-6 py-2 bg-white font-medium text-gray-700 hover:bg-gray-50">Batal</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const questionTypeSelect = document.getElementById('id_question_type');
    const optionsDiv = document.getElementById('div_id_options');

    if (questionTypeSelect && optionsDiv) {
        function toggleOptionsField() {
            if (questionTypeSelect.value === 'PILIHAN_GANDA') {
                optionsDiv.style.display = 'block';
            } else {
                optionsDiv.style.display = 'none';
            }
        }
        toggleOptionsField();
        questionTypeSelect.addEventListener('change', toggleOptionsField);
    }
});
</script>
{% endblock %}