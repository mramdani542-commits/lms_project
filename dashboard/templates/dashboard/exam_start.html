{% extends 'dashboard/layouts/base_fullscreen.html' %}
{% load static %}

{% block title %}Mengerjakan Ujian: {{ exam.name }}{% endblock %}

{% block body_content %}
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']]
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>
<!-- Menyimpan data dari Django di sini -->
<div id="exam-data-container"
     data-time-left="{{ time_left }}"
     data-attempt-pk="{{ attempt.pk }}"
     class="hidden">
    {% csrf_token %}
    <script id="exam-questions-json" type="application/json">{{ questions_json|safe }}</script>
    <script id="saved-answers-json" type="application/json">{{ saved_answers_json|safe }}</script>
</div>

<!-- Gerbang Fullscreen (Akan dikontrol oleh JS) -->
<div id="fullscreen-gate" class="fixed inset-0 bg-gray-100 z-50 flex items-center justify-center text-center p-4">
    <div class="max-w-md">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Persiapan Ujian</h1>
        <p class="text-gray-600 mb-8">Ujian akan ditampilkan dalam mode layar penuh (fullscreen) untuk menjaga fokus. Pastikan Anda siap dan tidak keluar dari mode ini selama ujian berlangsung.</p>
        <button id="start-exam-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
            Mulai Ujian Sekarang
        </button>
    </div>
</div>

<!-- Kontainer Ujian Utama -->
<div id="exam-container" class="hidden flex items-center justify-center min-h-screen w-full bg-gray-100 p-4">
    <div class="container mx-auto max-w-6xl w-full">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Kolom Kiri: Soal dan Pilihan Jawaban -->
            <div class="lg:col-span-2 bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <!-- Header Soal -->
                <div class="flex justify-between items-start mb-6 border-b pb-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">{{ exam.name }}</h1>
                        <p class="text-gray-500">{{ exam.MataPelajaran.nama }} - {{ exam.class_group.name }}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-gray-500 text-sm">Sisa Waktu</span>
                        <div id="timer-display" class="text-2xl font-bold text-red-500 bg-red-100 px-4 py-2 rounded-lg">
                            --:--:--
                        </div>
                    </div>
                </div>
                <!-- Konten Soal -->
                <div id="question-area" class="min-h-[400px]"></div>
                <!-- Tombol Navigasi Bawah -->
                <div class="mt-8 pt-6 border-t flex justify-between items-center">
                    <button id="prev-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        Sebelumnya
                    </button>
                    <button id="mark-review-btn" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center"></button>
                    <button id="next-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                        Selanjutnya
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
            <!-- Kolom Kanan: Navigasi Soal -->
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg self-start sticky top-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-3">Navigasi Soal</h2>
                <div id="question-nav-grid" class="grid grid-cols-5 gap-3"></div>
                <div class="mt-6">
                    <button id="finish-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                        Selesaikan Ujian
                    </button>
                </div>
                <div class="mt-6 text-sm text-gray-600 space-y-2">
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-500 mr-2"></span> Dijawab</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-yellow-400 mr-2"></span> Ragu-ragu</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full border-2 border-gray-300 mr-2"></span> Dilewati</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Konfirmasi & Peringatan -->
<div id="alert-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center text-gray-800">
        <h2 id="alert-title" class="text-xl font-bold mb-2"></h2>
        <p id="alert-message" class="text-gray-600 mb-6"></p>
        <div id="alert-buttons" class="flex justify-center gap-4"></div>
    </div>
</div>

<style>
    body { font-family: 'Inter', sans-serif; }
    .active-question-nav { border: 3px solid #3b82f6; font-weight: 700; color: #3b82f6; }
    .doubtful-question-nav { background-color: #facc15; color: #422006; border-color: #facc15; }
    .answered-question-nav { background-color: #22c55e; color: white; border-color: #22c55e; }
    .question-image-container img { max-width: 100%; max-height: 400px; height: auto; border-radius: 0.5rem; margin-top: 1rem; margin-bottom: 1rem; border: 1px solid #e5e7eb; object-fit: contain; display: block; margin-left: auto; margin-right: auto; }
</style>
{% endblock %}

{% block extra_script %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- ELEMEN PENTING ---
     const elements = {
        examContainer: document.getElementById('exam-container'),
        gate: document.getElementById('fullscreen-gate'),
        startBtn: document.getElementById('start-exam-btn'),
        timer: document.getElementById('timer-display'),
        questionArea: document.getElementById('question-area'),
        navGrid: document.getElementById('question-nav-grid'),
        prevBtn: document.getElementById('prev-btn'),
        nextBtn: document.getElementById('next-btn'),
        markBtn: document.getElementById('mark-review-btn'),
        finishBtn: document.getElementById('finish-btn'),
        modal: document.getElementById('alert-modal'),
        modalTitle: document.getElementById('alert-title'),
        modalMessage: document.getElementById('alert-message'),
        modalButtons: document.getElementById('alert-buttons'),
    };

    // --- DATA DARI DJANGO ---
    let questions, savedAnswers, attemptPk, csrfToken, initialTimeLeft;
    try {
        const dataContainer = document.getElementById('exam-data-container');
        attemptPk = dataContainer.dataset.attemptPk;
        csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        initialTimeLeft = parseFloat(dataContainer.dataset.timeLeft);
        questions = JSON.parse(document.getElementById('exam-questions-json').textContent);
        savedAnswers = JSON.parse(document.getElementById('saved-answers-json').textContent);
    } catch (error) {
        console.error("CRITICAL ERROR: Gagal mem-parsing data dari Django.", error);
        showAlert('Error Kritis', 'Gagal memuat data ujian. Silakan hubungi administrator.', []);
        return;
    }
    
    // --- STATE UJIAN ---
    let state = {
        currentQuestionIndex: 0,
        timeLeft: initialTimeLeft,
        timerInterval: null,
        studentAnswers: questions.map(q => {
            const saved = savedAnswers[q.pk];
            return {
                pk: q.pk,
                answer: saved ? saved.answer : null,
                isMarked: saved ? saved.is_marked : false,
                isAnswered: !!(saved && saved.answer !== null && saved.answer !== ''),
            };
        }),
        isExamActive: false,
        saveInterval: null
    };

    async function saveProgress() {
        if (!state.isExamActive || !attemptPk) return;
        const answersForBackend = {};
        state.studentAnswers.forEach(ans => {
            if (ans.isAnswered || ans.isMarked) {
                answersForBackend[ans.pk] = { answer: ans.answer, is_marked: ans.isMarked };
            }
        });

        try {
            await fetch(`/exam/attempt/${attemptPk}/save/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ answers: answersForBackend })
            });
        } catch (error) { console.error('Gagal menyimpan progress:', error); }
    }

    function init() {
        if (!questions || questions.length === 0) {
            showAlert('Error', 'Tidak ada soal untuk ujian ini.', [{ text: 'Kembali', action: () => window.history.back(), class: 'bg-red-500 text-white font-bold py-2 px-6 rounded-lg' }]);
            return;
        }
        
        elements.startBtn.addEventListener('click', startExam);
        
        elements.prevBtn.addEventListener('click', () => navigateQuestion(state.currentQuestionIndex - 1));
        elements.nextBtn.addEventListener('click', () => navigateQuestion(state.currentQuestionIndex + 1));
        elements.markBtn.addEventListener('click', handleMarkReview);
        elements.finishBtn.addEventListener('click', handleFinishExam);
        updateTimerDisplay();
    }

    async function submitExam() {
        if (!state.isExamActive) return;
        state.isExamActive = false;
        clearInterval(state.timerInterval);
        clearInterval(state.saveInterval);
        await saveProgress();
        removeAntiCheat();
        hideAlert();

        const answersForBackend = {};
        state.studentAnswers.forEach(ans => {
            if (ans.isAnswered || ans.isMarked) {
                answersForBackend[ans.pk] = { answer: ans.answer, is_marked: ans.isMarked };
            }
        });
        
        elements.finishBtn.disabled = true;
        elements.finishBtn.textContent = 'Mengirim...';

        try {
            const response = await fetch(`/exam/attempt/${attemptPk}/submit/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ answers: answersForBackend })
            });
            const result = await response.json();
            if (result.status === 'success') {
                window.location.href = result.redirect_url;
            } else {
                throw new Error(result.message || 'Gagal mengirim jawaban.');
            }
        } catch (error) {
            showAlert('Error', `Terjadi kesalahan: ${error.message}`, [{ text: 'Tutup', action: hideAlert, class: 'bg-red-500 text-white font-bold py-2 px-6 rounded-lg' }]);
            elements.finishBtn.disabled = false;
            elements.finishBtn.textContent = 'Selesaikan Ujian';
            state.isExamActive = true;
        }
    }

    function startExam() {
        enterFullscreen();
        
        // =======================================================
        // PERBAIKAN DI SINI: Tambahkan jeda singkat
        // =======================================================
        setTimeout(() => {
            elements.gate.classList.add('hidden');
            elements.examContainer.classList.remove('hidden');
            state.isExamActive = true;
            setupAntiCheat();
            renderAll();
            startTimer();
            state.saveInterval = setInterval(saveProgress, 30000);
            window.addEventListener('beforeunload', () => {
                if (state.isExamActive) saveProgress();
            });
        }, 200); // Jeda 200 milidetik
    }

    function navigateQuestion(index) {
        if (index < 0 || index >= questions.length) return;
        state.currentQuestionIndex = index;
        renderAll();
    }

    function renderAll() {
        renderQuestion();
        renderQuestionNav();
        updateNavButtons();
    }

    function renderQuestion() {
        const question = questions[state.currentQuestionIndex];
        const answerState = state.studentAnswers[state.currentQuestionIndex];
        let answerFieldHtml = '';
        
        let imageHtml = question.image_url ? `<div class="question-image-container my-4"><img src="${question.image_url}" alt="Gambar Soal"></div>` : '';
        let audioHtml = question.audio_url ? `<div class="question-audio-container my-4"><audio controls class="w-full"><source src="${question.audio_url}"></audio></div>` : '';

        switch (question.type) {
            case 'PILIHAN_GANDA':
                answerFieldHtml = `<div class="space-y-4 mt-6">`;
                if (Array.isArray(question.options) && question.options.length > 0) {
                    question.options.forEach((opt, index) => {
                        const optionLetter = String.fromCharCode(65 + index);
                        const isChecked = String(answerState.answer) === String(opt.id) ? 'checked' : '';
                        answerFieldHtml += `
                            <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 transition ${isChecked ? 'bg-blue-100 border-blue-500' : 'border-gray-300'}">
                                <input type="radio" name="question_${question.pk}" value="${opt.id}" class="mr-4" ${isChecked}>
                                <span class="font-medium text-gray-700">${optionLetter}. ${opt.text}</span>
                            </label>`;
                    });
                } else { answerFieldHtml += `<p class="text-red-500">Pilihan jawaban tidak tersedia.</p>`; }
                answerFieldHtml += `</div>`;
                break;
            
            case 'BENAR_SALAH':
                const options = [{id: 'Benar', text: 'Benar'}, {id: 'Salah', text: 'Salah'}];
                answerFieldHtml = `<div class="space-y-4 mt-6">`;
                options.forEach(opt => {
                    const isChecked = answerState.answer == opt.id ? 'checked' : '';
                    answerFieldHtml += `
                        <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 transition ${isChecked ? 'bg-blue-100 border-blue-500' : 'border-gray-300'}">
                            <input type="radio" name="question_${question.pk}" value="${opt.id}" class="mr-4" ${isChecked}>
                            <span class="font-medium text-gray-700">${opt.text}</span>
                        </label>`;
                });
                answerFieldHtml += `</div>`;
                break;

            case 'ISIAN_SINGKAT':
                const currentText = answerState.answer || '';
                answerFieldHtml = `<div class="mt-6"><input type="text" name="question_${question.pk}" value="${currentText}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base" placeholder="Ketik jawaban singkat Anda..."></div>`;
                break;
            
            case 'ESAI':
                const currentEssay = answerState.answer || '';
                answerFieldHtml = `<div class="mt-6"><textarea name="question_${question.pk}" rows="8" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base" placeholder="Ketik jawaban esai Anda...">${currentEssay}</textarea></div>`;
                break;

            case 'MENJODOHKAN':
                const currentAnswer = answerState.answer && typeof answerState.answer === 'object' ? answerState.answer : {};
                const answeredChoiceIds = Object.values(currentAnswer).map(String);
                let promptsHtml = '';
                let choicesHtml = '';

                if (question.options && Array.isArray(question.options.prompts) && Array.isArray(question.options.choices)) {
                    question.options.prompts.forEach(p => {
                        const choiceIdForThisPrompt = currentAnswer[p.id];
                        let droppedItemHtml = '';
                        if (choiceIdForThisPrompt) {
                            const choice = question.options.choices.find(c => String(c.id) === String(choiceIdForThisPrompt));
                            if (choice) {
                                droppedItemHtml = `<div class="choice-item p-3 border rounded-md bg-gray-100 cursor-grab" draggable="true" data-choice-id="${choice.id}">${choice.text}</div>`;
                            }
                        }
                        promptsHtml += `<div class="flex justify-between items-center p-3 border rounded-md mb-2"><span>${p.text}</span><div class="drop-zone" data-prompt-id="${p.id}">${droppedItemHtml}</div></div>`;
                    });

                    question.options.choices.forEach(c => {
                        if (!answeredChoiceIds.includes(String(c.id))) {
                            choicesHtml += `<div class="choice-item p-3 border rounded-md bg-gray-100 cursor-grab" draggable="true" data-choice-id="${c.id}">${c.text}</div>`;
                        }
                    });
                }
                
                answerFieldHtml = `
                    <div class="grid grid-cols-2 gap-8 mt-6">
                        <div><h4 class="font-semibold text-center mb-3">Pernyataan</h4><div class="space-y-2">${promptsHtml}</div></div>
                        <div><h4 class="font-semibold text-center mb-3">Pilihan (Tarik ke Kiri)</h4><div class="space-y-2" id="matching-choices-container">${choicesHtml}</div></div>
                    </div>
                `;
                setTimeout(() => setupDragAndDrop(question.pk), 0);
                break;
        }

        elements.questionArea.innerHTML = `
            <div class="flex items-start mb-4">
                <div class="flex-shrink-0 flex items-center justify-center w-10 h-10 bg-blue-500 text-white font-bold rounded-full mr-4">${state.currentQuestionIndex + 1}</div>
                <div class="text-lg text-gray-800 leading-relaxed prose max-w-none w-full">
                    <div>${question.text}</div>${imageHtml}${audioHtml}
                </div>
            </div>
            ${answerFieldHtml}`;

        const inputs = elements.questionArea.querySelectorAll(`input[name^='question_'], textarea[name^='question_']`);
        inputs.forEach(input => {
            const eventType = (input.type === 'text' || input.tagName.toLowerCase() === 'textarea') ? 'input' : 'change';
            input.addEventListener(eventType, handleAnswerChange);
        });

        if (window.MathJax) {
            MathJax.typesetPromise([elements.questionArea]);
        }
    }

    function setupDragAndDrop(questionPk) {
        const choices = document.querySelectorAll('.choice-item');
        const dropZones = document.querySelectorAll('.drop-zone');
        const choicesContainer = document.getElementById('matching-choices-container');
        let draggedItem = null;

        choices.forEach(choice => {
            choice.addEventListener('dragstart', () => {
                draggedItem = choice;
                setTimeout(() => choice.style.display = 'none', 0);
            });
            choice.addEventListener('dragend', () => {
                setTimeout(() => {
                    if (draggedItem) {
                        draggedItem.style.display = 'block';
                        draggedItem = null;
                    }
                }, 0);
            });
        });

        const allDropTargets = [...dropZones, choicesContainer];

        allDropTargets.forEach(target => {
            if (!target) return;
            target.addEventListener('dragover', e => e.preventDefault());
            target.addEventListener('dragenter', e => {
                e.preventDefault();
                target.classList.add('bg-blue-100');
            });
            target.addEventListener('dragleave', () => target.classList.remove('bg-blue-100'));
            target.addEventListener('drop', (e) => {
                e.preventDefault();
                target.classList.remove('bg-blue-100');
                if (draggedItem) {
                    if (target.classList.contains('drop-zone') && target.children.length > 0) {
                        choicesContainer.appendChild(target.children[0]);
                    }
                    target.appendChild(draggedItem);
                }
                handleMatchingAnswerChange();
            });
        });
    }
    
    function handleMatchingAnswerChange() {
        const answer = {};
        document.querySelectorAll('.drop-zone').forEach(zone => {
            const promptId = zone.dataset.promptId;
            const choice = zone.querySelector('.choice-item');
            if (promptId && choice) {
                answer[promptId] = choice.dataset.choiceId;
            }
        });
        
        const currentAnswerState = state.studentAnswers[state.currentQuestionIndex];
        currentAnswerState.answer = answer;
        currentAnswerState.isAnswered = Object.keys(answer).length > 0;
        renderQuestionNav();
    }

    function renderQuestionNav() {
        elements.navGrid.innerHTML = '';
        questions.forEach((_, index) => {
            const answerState = state.studentAnswers[index];
            const navButton = document.createElement('button');
            navButton.textContent = index + 1;
            navButton.className = 'border rounded-md py-2 px-1 text-center transition duration-200 font-medium';
            if (index === state.currentQuestionIndex) navButton.classList.add('active-question-nav');
            else if (answerState.isMarked) navButton.classList.add('doubtful-question-nav');
            else if (answerState.isAnswered) navButton.classList.add('answered-question-nav');
            else navButton.classList.add('bg-white', 'hover:bg-gray-100');
            navButton.addEventListener('click', () => navigateQuestion(index));
            elements.navGrid.appendChild(navButton);
        });
    }

    function updateNavButtons() {
        elements.prevBtn.disabled = state.currentQuestionIndex === 0;
        elements.nextBtn.disabled = state.currentQuestionIndex === questions.length - 1;
        const isMarked = state.studentAnswers[state.currentQuestionIndex].isMarked;
        elements.markBtn.innerHTML = isMarked ? `Batalkan Ragu-ragu` : `Ragu-ragu`;
    }

    function handleAnswerChange(event) {
        const currentAnswerState = state.studentAnswers[state.currentQuestionIndex];
        currentAnswerState.answer = event.target.value;
        currentAnswerState.isAnswered = !!event.target.value && event.target.value.trim() !== '';
        renderQuestionNav();
    }

    function handleMarkReview() {
        state.studentAnswers[state.currentQuestionIndex].isMarked = !state.studentAnswers[state.currentQuestionIndex].isMarked;
        renderAll();
    }

    function handleFinishExam() {
        const answeredCount = state.studentAnswers.filter(a => a.isAnswered).length;
        showAlert('Konfirmasi Selesai', `Anda telah menjawab ${answeredCount} dari ${questions.length} soal. Yakin?`, [
            { text: 'Batal', action: hideAlert, class: 'bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg' },
            { text: 'Ya, Kumpulkan', action: submitExam, class: 'bg-green-500 text-white font-bold py-2 px-6 rounded-lg' }
        ]);
    }

    function startTimer() {
        state.timerInterval = setInterval(() => {
            state.timeLeft--;
            updateTimerDisplay();
            if (state.timeLeft <= 0) {
                clearInterval(state.timerInterval);
                showAlert('Waktu Habis!', 'Waktu pengerjaan berakhir.', [
                    { text: 'OK', action: submitExam, class: 'bg-blue-600 text-white font-bold py-2 px-6 rounded-lg' }
                ]);
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        if (state.timeLeft < 0) return;
        const h = Math.floor(state.timeLeft / 3600);
        const m = Math.floor((state.timeLeft % 3600) / 60);
        const s = state.timeLeft % 60;
        elements.timer.textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    function showAlert(title, message, buttons) {
        elements.modalTitle.textContent = title;
        elements.modalMessage.textContent = message;
        elements.modalButtons.innerHTML = '';
        buttons.forEach(btnInfo => {
            const button = document.createElement('button');
            button.textContent = btnInfo.text;
            button.className = btnInfo.class;
            button.onclick = btnInfo.action;
            elements.modalButtons.appendChild(button);
        });
        elements.modal.classList.remove('hidden');
        elements.modal.classList.add('flex');
    }

    function hideAlert() {
        elements.modal.classList.add('hidden');
        elements.modal.classList.remove('flex');
    }
    
    function enterFullscreen() {
        document.documentElement.requestFullscreen().catch(err => console.error(err));
    }

    const onFullscreenChange = () => {
        setTimeout(() => {
            if (!document.fullscreenElement && state.isExamActive) {
                handleViolation();
            }
        }, 100);
    };
    const onVisibilityChange = () => {
        if (document.visibilityState === 'hidden' && state.isExamActive) {
            handleViolation();
        }
    };
    const onBlur = () => { setTimeout(() => { if (!document.hasFocus()) handleViolation(); }, 100); };
    const onContextMenu = e => e.preventDefault();

    function handleViolation() {
        if (!state.isExamActive) return;
        saveProgress();
        state.isExamActive = false;
        clearInterval(state.timerInterval);
        removeAntiCheat();
        
        const resumeUrl = `{% url 'exam_token_gate' pk=exam.pk %}`;

        showAlert(
            'Pelanggaran Terdeteksi', 
            'Anda telah keluar dari mode layar penuh atau beralih jendela. Ujian telah dijeda. Klik tombol di bawah untuk melanjutkan.', 
            [{ 
                text: 'Lanjutkan Ujian', 
                action: () => { window.location.href = resumeUrl; },
                class: 'bg-blue-600 text-white font-bold py-2 px-6 rounded-lg'
            }]
        );
    }

    function setupAntiCheat() {
        document.addEventListener('fullscreenchange', onFullscreenChange);
        window.addEventListener('blur', onBlur);
        document.addEventListener('contextmenu', onContextMenu);
    }

    function removeAntiCheat() {
        document.removeEventListener('fullscreenchange', onFullscreenChange);
        window.removeEventListener('blur', onBlur);
        document.removeEventListener('contextmenu', onContextMenu);
    }

    init();
});
</script>
{% endblock %}
