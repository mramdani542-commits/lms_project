{% extends 'dashboard/layouts/base_fullscreen.html' %}
{% load static %}

{% block title %}Mengerjakan Ujian: {{ exam.name }}{% endblock %}

{% block body_content %}
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']]
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>
<!-- Menyimpan data dari Django di sini -->
<div id="exam-data-container"
     data-time-left="{{ time_left|default:'null' }}"
     data-attempt-pk="{{ attempt_pk }}"
     class="hidden">
    <script id="exam-questions-json" type="application/json">
        {{ questions_json|safe|default:"[]" }}
    </script>
    <script id="saved-answers-json" type="application/json">
        {{ saved_answers_json|safe|default:"{}" }}
    </script>
</div>

<!-- Gerbang Fullscreen -->
<div id="fullscreen-gate" class="fixed inset-0 bg-gray-100 z-50 flex items-center justify-center text-center p-4">
    <div class="max-w-md">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Persiapan Ujian</h1>
        <p class="text-gray-600 mb-8">Ujian akan ditampilkan dalam mode layar penuh (fullscreen) untuk menjaga fokus. Pastikan Anda siap dan tidak keluar dari mode ini selama ujian berlangsung.</p>
        <button id="start-exam-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105">
            Mulai Ujian Sekarang
        </button>
    </div>
</div>

<!-- Kontainer Ujian Utama -->
<div id="exam-container" class="hidden flex items-center justify-center min-h-screen w-full bg-gray-100 p-4">
    <div class="container mx-auto max-w-6xl w-full">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Kolom Kiri: Soal dan Pilihan Jawaban -->
            <div class="lg:col-span-2 bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <!-- Header Soal -->
                <div class="flex justify-between items-start mb-6 border-b pb-4">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">{{ exam.name }}</h1>
                        <p class="text-gray-500">{{ exam.MataPelajaran.nama }} - {{ exam.class_group.name }}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-gray-500 text-sm">Sisa Waktu</span>
                        <div id="timer-display" class="text-2xl font-bold text-red-500 bg-red-100 px-4 py-2 rounded-lg">
                            --:--:--
                        </div>
                    </div>
                </div>

                <!-- Konten Soal -->
                <div id="question-area" class="min-h-[400px]">
                    <!-- Soal akan dimuat di sini oleh JavaScript -->
                </div>

                <!-- Tombol Navigasi Bawah -->
                <div class="mt-8 pt-6 border-t flex justify-between items-center">
                    <button id="prev-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        Sebelumnya
                    </button>
                    <button id="mark-review-btn" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center">
                        <!-- Konten tombol Ragu-ragu akan diubah oleh JS -->
                    </button>
                    <button id="next-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                        Selanjutnya
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>

            <!-- Kolom Kanan: Navigasi Soal -->
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg self-start sticky top-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-3">Navigasi Soal</h2>
                <div id="question-nav-grid" class="grid grid-cols-5 gap-3">
                    <!-- Nomor soal akan dimuat di sini -->
                </div>
                <div class="mt-6">
                    <button id="finish-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
                        Selesaikan Ujian
                    </button>
                </div>
                <div class="mt-6 text-sm text-gray-600 space-y-2">
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-green-500 mr-2"></span> Dijawab</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full bg-yellow-400 mr-2"></span> Ragu-ragu</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full border-2 border-gray-300 mr-2"></span> Dilewati</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Konfirmasi & Peringatan -->
<div id="alert-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center text-gray-800">
        <h2 id="alert-title" class="text-xl font-bold mb-2"></h2>
        <p id="alert-message" class="text-gray-600 mb-6"></p>
        <div id="alert-buttons" class="flex justify-center gap-4">
            <!-- Tombol akan dimasukkan di sini oleh JavaScript -->
        </div>
    </div>
</div>

<!-- Form tersembunyi untuk pengumpulan jawaban -->
<form id="exam-form" method="POST" action="{% url 'exam_submit' exam.pk %}" class="hidden">
    {% csrf_token %}
    <div id="answers-container"></div>
</form>

<style>
    body {
        font-family: 'Inter', sans-serif;
    }
    .active-question-nav {
        border: 3px solid #3b82f6;
        font-weight: 700;
        color: #3b82f6;
    }
    .doubtful-question-nav {
        background-color: #facc15;
        color: #422006;
        border-color: #facc15;
    }
    .answered-question-nav {
        background-color: #22c55e;
        color: white;
        border-color: #22c55e;
    }
    /* Tambahan style untuk gambar soal */
    .question-image-container img {
        max-width: 100%;
        max-height: 400px; /* Batasi tinggi gambar agar tidak terlalu besar */
        height: auto;
        border-radius: 0.5rem;
        margin-top: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #e5e7eb;
        object-fit: contain; /* Pastikan gambar tidak terdistorsi */
        display: block;
        margin-left: auto;
        margin-right: auto;
    }
</style>
{% endblock %}

{% block extra_script %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- ELEMEN PENTING ---
    const elements = {
        examContainer: document.getElementById('exam-container'),
        gate: document.getElementById('fullscreen-gate'),
        startBtn: document.getElementById('start-exam-btn'),
        timer: document.getElementById('timer-display'),
        questionArea: document.getElementById('question-area'),
        navGrid: document.getElementById('question-nav-grid'),
        prevBtn: document.getElementById('prev-btn'),
        nextBtn: document.getElementById('next-btn'),
        markBtn: document.getElementById('mark-review-btn'),
        finishBtn: document.getElementById('finish-btn'),
        modal: document.getElementById('alert-modal'),
        modalTitle: document.getElementById('alert-title'),
        modalMessage: document.getElementById('alert-message'),
        modalButtons: document.getElementById('alert-buttons'),
    };

    // --- DATA DARI DJANGO ---
    const dataContainer = document.getElementById('exam-data-container');
    const examPk = '{{ exam.pk }}';
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const examDurationMinutes = parseInt(dataContainer.dataset.durationMinutes, 10) || 0;
    const initialTimeLeftStr = dataContainer.dataset.timeLeft;
    const initialTimeLeft = initialTimeLeftStr !== 'null' ? parseFloat(initialTimeLeftStr) : null;
    
    let questions = [];
    try {
        const questionsDataEl = document.getElementById('exam-questions-json');
        if (questionsDataEl && questionsDataEl.textContent.trim()) {
            questions = JSON.parse(questionsDataEl.textContent);
        } else { throw new Error("Elemen #exam-questions-json kosong."); }
    } catch (e) {
        console.error("Gagal mem-parsing data soal JSON:", e);
        showAlert('Error Kritis', 'Tidak dapat memuat data soal.', [{ text: 'Kembali', action: () => window.history.back() }]);
        return;
    }

    // --- STATE UJIAN ---
    let state = {
        currentQuestionIndex: 0,
        timeLeft: initialTimeLeft,
        timerInterval: null,
        // --- PERUBAHAN: Inisialisasi jawaban dari data tersimpan ---
        studentAnswers: questions.map(q => {
            const saved = savedAnswers[q.pk];
            return {
                pk: q.pk,
                answer: saved ? saved.answer : null,
                isMarked: saved ? saved.is_marked : false,
                isAnswered: !!(saved && saved.answer),
            };
        }),
        isExamActive: false
    };
    // --- FUNGSI BARU UNTUK MENYIMPAN PROGRESS ---
    let saveInterval = null;
    async function saveProgress() {
        if (!state.isExamActive || !attemptPk) return;

        const answersForBackend = {};
        state.studentAnswers.forEach(ans => {
            if (ans.isAnswered || ans.isMarked) {
                answersForBackend[ans.pk] = { answer: ans.answer, is_marked: ans.isMarked };
            }
        });

        try {
            await fetch(`/exam/attempt/${attemptPk}/save/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ answers: answersForBackend })
            });
            console.log('Progress saved at', new Date().toLocaleTimeString());
        } catch (error) {
            console.error('Failed to save progress:', error);
        }
    }

    // --- FUNGSI UTAMA ---
    function init() {
        if (questions.length === 0) {
            showAlert('Error', 'Tidak ada soal untuk ujian ini.', [{ text: 'Kembali', action: () => window.history.back() }]);
            return;
        }
        elements.startBtn.addEventListener('click', startExam);
    }

    function startExam() {
        // ... (logika startExam Anda) ...
        state.isExamActive = true;
        renderAll(); // Panggil renderAll untuk memuat jawaban tersimpan ke UI
        startTimer();
        
        // --- BARU: Mulai menyimpan otomatis setiap 30 detik ---
        saveInterval = setInterval(saveProgress, 30000); 
        
        // --- BARU: Simpan saat pengguna akan meninggalkan halaman ---
        window.addEventListener('beforeunload', (event) => {
            if (state.isExamActive) {
                saveProgress(); // Lakukan penyimpanan terakhir
            }
        });
    }

    function navigateQuestion(index) {
        if (index < 0 || index >= questions.length) return;
        state.currentQuestionIndex = index;
        renderAll();
    }

    function renderQuestion() {
        const question = questions[state.currentQuestionIndex];
        const answerState = state.studentAnswers[state.currentQuestionIndex];
        let answerFieldHtml = '';
        
        let imageHtml = question.image_url ? `<div class="question-image-container my-4"><img src="${question.image_url}" alt="Gambar Soal"></div>` : '';
        let audioHtml = question.audio_url ? `<div class="question-audio-container my-4"><audio controls class="w-full"><source src="${question.audio_url}"></audio></div>` : '';

        switch (question.type) {
            case 'PILIHAN_GANDA':
                answerFieldHtml = `<div class="space-y-4 mt-6">`;
                if (Array.isArray(question.options) && question.options.length > 0) {
                    question.options.forEach((opt, index) => {
                        const optionLetter = String.fromCharCode(65 + index);
                        const isChecked = String(answerState.answer) === String(opt.id) ? 'checked' : '';
                        answerFieldHtml += `
                            <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 transition ${isChecked ? 'bg-blue-100 border-blue-500' : 'border-gray-300'}">
                                <input type="radio" name="question_${question.pk}" value="${opt.id}" class="mr-4" ${isChecked}>
                                <span class="font-medium text-gray-700">${optionLetter}. ${opt.text}</span>
                            </label>`;
                    });
                } else { answerFieldHtml += `<p class="text-red-500">Pilihan jawaban tidak tersedia.</p>`; }
                answerFieldHtml += `</div>`;
                break;
            
            case 'BENAR_SALAH':
                const options = [{id: 'Benar', text: 'Benar'}, {id: 'Salah', text: 'Salah'}];
                answerFieldHtml = `<div class="space-y-4 mt-6">`;
                options.forEach(opt => {
                    const isChecked = answerState.answer == opt.id ? 'checked' : '';
                    answerFieldHtml += `
                        <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 transition ${isChecked ? 'bg-blue-100 border-blue-500' : 'border-gray-300'}">
                            <input type="radio" name="question_${question.pk}" value="${opt.id}" class="mr-4" ${isChecked}>
                            <span class="font-medium text-gray-700">${opt.text}</span>
                        </label>`;
                });
                answerFieldHtml += `</div>`;
                break;

            case 'ISIAN_SINGKAT':
                const currentText = answerState.answer || '';
                answerFieldHtml = `<div class="mt-6"><input type="text" name="question_${question.pk}" value="${currentText}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base" placeholder="Ketik jawaban singkat Anda..."></div>`;
                break;
            
            case 'ESAI':
                const currentEssay = answerState.answer || '';
                answerFieldHtml = `<div class="mt-6"><textarea name="question_${question.pk}" rows="8" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base" placeholder="Ketik jawaban esai Anda...">${currentEssay}</textarea></div>`;
                break;

            case 'MENJODOHKAN':
                if (question.options && question.options.prompts && question.options.choices) {
                    let promptsHtml = '';
                    question.options.prompts.forEach(p => {
                        promptsHtml += `
                            <div class="prompt-item">
                                <div class="font-medium text-gray-700 flex-1">${p.text}</div>
                                <div class="drop-zone" data-prompt-id="${p.id}"></div>
                            </div>`;
                    });
                    let choicesHtml = '';
                    const shuffledChoices = [...question.options.choices].sort(() => Math.random() - 0.5);
                    shuffledChoices.forEach(c => {
                        choicesHtml += `<div class="choice-item" draggable="true" data-choice-id="${c.id}">${c.text}</div>`;
                    });
                    answerFieldHtml = `
                        <div class="matching-container mt-8">
                            <div class="matching-prompts">
                                <h3 class="font-semibold text-center mb-2">Pernyataan</h3>
                                ${promptsHtml}
                            </div>
                            <div class="matching-choices">
                                <h3 class="font-semibold text-center mb-2">Pilihan Jawaban (Tarik)</h3>
                                ${choicesHtml}
                            </div>
                        </div>`;
                    setTimeout(() => setupDragAndDrop(question.pk), 0);
                } else {
                    answerFieldHtml = `<p class="text-red-500">Opsi untuk soal menjodohkan tidak tersedia.</p>`;
                }
                break;
            default:
                answerFieldHtml = `<p class="mt-6 text-red-500">Tipe soal tidak dikenali.</p>`;
        }

        elements.questionArea.innerHTML = `
            <div class="flex items-start mb-4">
                <div class="flex-shrink-0 flex items-center justify-center w-10 h-10 bg-blue-500 text-white font-bold rounded-full mr-4">${state.currentQuestionIndex + 1}</div>
                <div class="text-lg text-gray-800 leading-relaxed prose max-w-none w-full">
                    <div>${question.text}</div>${imageHtml}${audioHtml}
                </div>
            </div>
            ${answerFieldHtml}`;

        const inputs = elements.questionArea.querySelectorAll(`input[name^='question_'], textarea[name^='question_'], select[name^='question_']`);
        inputs.forEach(input => {
            const eventType = (input.type === 'text' || input.tagName.toLowerCase() === 'textarea') ? 'input' : 'change';
            input.addEventListener(eventType, handleAnswerChange);
        });
        if (window.MathJax) {
            MathJax.typesetPromise([elements.questionArea, elements.passageArea]);
        }
    }
    function setupDragAndDrop(questionPk) {
        const choices = document.querySelectorAll('.choice-item');
        const dropZones = document.querySelectorAll('.drop-zone');
        let draggedItem = null;
        choices.forEach(choice => {
            choice.addEventListener('dragstart', () => {
                draggedItem = choice;
                setTimeout(() => choice.style.display = 'none', 0);
            });
            choice.addEventListener('dragend', () => {
                setTimeout(() => {
                    draggedItem.style.display = 'block';
                    draggedItem = null;
                }, 0);
            });
        });
        dropZones.forEach(zone => {
            zone.addEventListener('dragover', e => e.preventDefault());
            zone.addEventListener('dragenter', e => {
                e.preventDefault();
                zone.classList.add('over');
            });
            zone.addEventListener('dragleave', () => zone.classList.remove('over'));
            zone.addEventListener('drop', () => {
                zone.classList.remove('over');
                if (zone.children.length === 0) {
                    zone.appendChild(draggedItem);
                    draggedItem.classList.add('placed');
                    handleMatchingAnswerChange();
                }
            });
        });
        document.querySelector('.matching-choices').addEventListener('click', e => {
            if (e.target.classList.contains('placed')) {
                document.querySelector('.matching-choices').appendChild(e.target);
                e.target.classList.remove('placed');
                handleMatchingAnswerChange();
            }
        });
    }

    function renderQuestionNav() {
        elements.navGrid.innerHTML = '';
        questions.forEach((_, index) => {
            const answerState = state.studentAnswers[index];
            const navButton = document.createElement('button');
            navButton.textContent = index + 1;
            navButton.className = 'border rounded-md py-2 px-1 text-center transition duration-200 font-medium';
            if (index === state.currentQuestionIndex) navButton.classList.add('active-question-nav');
            else if (answerState.isMarked) navButton.classList.add('doubtful-question-nav');
            else if (answerState.isAnswered) navButton.classList.add('answered-question-nav');
            else navButton.classList.add('bg-white', 'hover:bg-gray-100');
            navButton.addEventListener('click', () => navigateQuestion(index));
            elements.navGrid.appendChild(navButton);
        });
    }

    function updateNavButtons() {
        elements.prevBtn.disabled = state.currentQuestionIndex === 0;
        elements.nextBtn.disabled = state.currentQuestionIndex === questions.length - 1;
        const isMarked = state.studentAnswers[state.currentQuestionIndex].isMarked;
        elements.markBtn.innerHTML = isMarked ? `Batalkan Ragu-ragu` : `Ragu-ragu`;
    }

    function renderAll() {
        renderQuestion();
        renderQuestionNav();
        updateNavButtons();
    }

    function handleAnswerChange(event) {
        const currentAnswerState = state.studentAnswers[state.currentQuestionIndex];
        const questionType = questions[state.currentQuestionIndex].type;

        if (questionType === 'MENJODOHKAN') {
            if (typeof currentAnswerState.answer !== 'object' || currentAnswerState.answer === null) {
                currentAnswerState.answer = {};
            }
            const promptId = event.target.dataset.promptId;
            const selectedValue = event.target.value;
            if (selectedValue) {
                currentAnswerState.answer[promptId] = selectedValue;
            } else {
                delete currentAnswerState.answer[promptId];
            }
            currentAnswerState.isAnswered = Object.keys(currentAnswerState.answer).length > 0;
        } else {
            currentAnswerState.answer = event.target.value;
            currentAnswerState.isAnswered = !!event.target.value && event.target.value.trim() !== '';
        }
        renderQuestionNav();
    }

    function handleMarkReview() {
        state.studentAnswers[state.currentQuestionIndex].isMarked = !state.studentAnswers[state.currentQuestionIndex].isMarked;
        renderAll();
    }

    function handleFinishExam() {
        const answeredCount = state.studentAnswers.filter(a => a.isAnswered).length;
        showAlert('Konfirmasi Selesai', `Anda telah menjawab ${answeredCount} dari ${questions.length} soal. Yakin?`, [
            { text: 'Batal', action: hideAlert, class: 'bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg' },
            { text: 'Ya, Kumpulkan', action: submitExamWithFetch, class: 'bg-green-500 text-white font-bold py-2 px-6 rounded-lg' }
        ]);
    }

    async function submitExamWithFetch() {
        if (!state.isExamActive) return;
        state.isExamActive = false;
        clearInterval(state.timerInterval);
        await saveProgress();
        removeAntiCheat(); // Panggil fungsi yang sudah diperbaiki
        hideAlert();

        const answersForBackend = {};
        state.studentAnswers.forEach(ans => {
            if (ans.isAnswered || ans.isMarked) {
                answersForBackend[ans.pk] = { answer: ans.answer, is_marked: ans.isMarked };
            }
        });

        elements.finishBtn.disabled = true;
        elements.finishBtn.textContent = 'Mengirim...';

        try {
            const response = await fetch(`/exam/${examPk}/submit/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ answers: answersForBackend })
            });
            const result = await response.json();
            if (result.status === 'success') {
                showAlert('Berhasil', result.message, [{ text: 'OK', action: () => window.location.href = result.redirect_url, class: 'bg-blue-600 text-white font-bold py-2 px-6 rounded-lg' }]);
            } else {
                throw new Error(result.message || 'Gagal mengirim jawaban.');
            }
        } catch (error) {
            showAlert('Error', `Terjadi kesalahan: ${error.message}`, [{ text: 'Tutup', action: hideAlert, class: 'bg-red-500 text-white font-bold py-2 px-6 rounded-lg' }]);
            elements.finishBtn.disabled = false;
            elements.finishBtn.textContent = 'Selesaikan Ujian';
            state.isExamActive = true;
        }
    }

    function startTimer() {
        state.timerInterval = setInterval(() => {
            state.timeLeft--;
            updateTimerDisplay();
            if (state.timeLeft <= 0) {
                clearInterval(state.timerInterval);
                showAlert('Waktu Habis!', 'Waktu pengerjaan berakhir.', [
                    { text: 'OK', action: submitExamWithFetch, class: 'bg-blue-600 text-white font-bold py-2 px-6 rounded-lg' }
                ]);
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        if (state.timeLeft < 0) return;
        const h = Math.floor(state.timeLeft / 3600);
        const m = Math.floor((state.timeLeft % 3600) / 60);
        const s = state.timeLeft % 60;
        elements.timer.textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    function showAlert(title, message, buttons) {
        elements.modalTitle.textContent = title;
        elements.modalMessage.textContent = message;
        elements.modalButtons.innerHTML = '';
        buttons.forEach(btnInfo => {
            const button = document.createElement('button');
            button.textContent = btnInfo.text;
            button.className = btnInfo.class;
            button.onclick = btnInfo.action;
            elements.modalButtons.appendChild(button);
        });
        elements.modal.classList.remove('hidden');
        elements.modal.classList.add('flex');
    }

    function hideAlert() {
        elements.modal.classList.add('hidden');
        elements.modal.classList.remove('flex');
    }
    
    function enterFullscreen() {
        document.documentElement.requestFullscreen().catch(err => console.error(err));
    }

    // --- PERBAIKAN FUNGSI ANTI-CURANG ---

    // Definisikan fungsi handler dengan nama agar bisa dihapus
    const onFullscreenChange = () => { if (!document.fullscreenElement) handleViolation(); };
    const onBlur = () => { setTimeout(() => { if (!document.hasFocus()) handleViolation(); }, 100); };
    const onContextMenu = e => e.preventDefault();

    function handleViolation() {
        if (!state.isExamActive) return;
        saveProgress();
        state.isExamActive = false;
        clearInterval(state.timerInterval);
        removeAntiCheat();
        
        // --- PERUBAHAN 1: Gunakan exam.pk bukan exam.id ---
        const resumeUrl = "{% url 'resume_exam_with_token' exam_pk=exam.pk %}";

        // --- PERUBAHAN 2: Tampilkan modal sebelum redirect ---
        showAlert(
            'Pelanggaran Terdeteksi', 
            'Anda telah keluar dari mode layar penuh atau beralih jendela. Ujian telah dijeda. Klik tombol di bawah untuk melanjutkan.', 
            [{ 
                text: 'Lanjutkan Ujian', 
                action: () => { window.location.href = resumeUrl; },
                class: 'bg-blue-600 text-white font-bold py-2 px-6 rounded-lg'
            }]
        );
    }

    function setupAntiCheat() {
        document.addEventListener('fullscreenchange', onFullscreenChange);
        window.addEventListener('blur', onBlur);
        document.addEventListener('contextmenu', onContextMenu);
    }

    function removeAntiCheat() {
        document.removeEventListener('fullscreenchange', onFullscreenChange);
        window.removeEventListener('blur', onBlur);
        document.removeEventListener('contextmenu', onContextMenu);
    }

    init();
});
</script>
{% endblock %}
