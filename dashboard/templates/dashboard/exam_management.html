{% extends 'dashboard/layouts/base.html' %}
{% load static %}
{% load exam_tags %} 

{% block title %}Manajemen Ujian{% endblock %}
{% block page_title %}Manajemen Ujian{% endblock %}

{% block content %}
<div class="grid grid-cols-1 {% if request.user.role != 'SISWA' %}lg:grid-cols-3{% endif %} gap-6">
    
    {% if request.user.role != 'SISWA' %}
    <div class="lg:col-span-1">
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-lg font-semibold mb-4">Buat Ujian Baru</h2>
            
            {% if messages %}
                {% for message in messages %}
                <div class="p-4 mb-4 rounded-md text-sm {% if message.tags == 'success' %} bg-green-100 text-green-800 {% else %} bg-red-100 text-red-800 {% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
            
            <form method="POST" class="space-y-4">
                {% csrf_token %}
                
                {% for field in form %}
                <div>
                    <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ field.label }}</label>
                    {{ field }}
                    {% if field.help_text %}
                        <p class="mt-1 text-xs text-gray-500">{{ field.help_text|safe }}</p>
                    {% endif %}
                    {% for error in field.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ error }}</p>
                    {% endfor %}
                </div>
                {% endfor %}

                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">
                    Buat Ujian
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="{% if request.user.role != 'SISWA' %}lg:col-span-2{% else %}col-span-full{% endif %}">
        <div class="bg-white p-6 rounded-lg shadow-md" x-data="{ searchQuery: '' }">
            <h2 class="text-lg font-semibold mb-4">Daftar Ujian</h2>
            
            <div class="mb-6">
                <input type="text" x-model="searchQuery" placeholder="Cari nama ujian atau mata pelajaran..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>

            <div class="space-y-6">
                {% for level, exams_in_level in grouped_exams.items %}
                <div x-data="{ open: true }">
                    <button @click="open = !open" class="w-full flex justify-between items-center text-left">
                        <h3 class="text-xl font-bold text-gray-800">{{ level }}</h3>
                        <i class="ph ph-caret-down text-2xl transition-transform" :class="{'rotate-180': !open}"></i>
                    </button>

                    <div x-show="open" x-transition class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% for exam in exams_in_level %}
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-lg transition-shadow" 
                             x-show="searchQuery === '' || '{{ exam.name|lower }}'.includes(searchQuery.toLowerCase()) || '{{ exam.MataPelajaran.nama|lower }}'.includes(searchQuery.toLowerCase())">
                            
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-md text-indigo-700">{{ exam.name }}</h4>
                                    <p class="text-sm text-gray-600">{{ exam.MataPelajaran.nama }} - {{ exam.class_group.name }}</p>
                                </div>
                                <span class="text-xs font-semibold text-gray-500 bg-gray-100 px-2 py-1 rounded-full">{{ exam.questions.count }} Soal</span>
                            </div>

                            <div class="mt-3 text-sm text-gray-500 space-y-1">
                                <p><strong>Mulai:</strong> {{ exam.start_time|date:"d M Y, H:i" }}</p>
                                <p><strong>Selesai:</strong> {{ exam.end_time|date:"d M Y, H:i" }}</p>
                                <p><strong>Durasi:</strong> {{ exam.duration_minutes }} menit</p>
                                
                                <!-- ================================================== -->
                                <!-- PERUBAHAN 1: Menampilkan Nama Guru Pembuat Ujian   -->
                                <!-- ================================================== -->
                                {% if exam.created_by %}
                                <p><strong>Dibuat oleh:</strong> {{ exam.created_by.get_full_name|default:exam.created_by.username }}</p>
                                {% endif %}

                                <!-- ========================================================================= -->
                                <!-- PERUBAHAN 2: Menampilkan Multi-Token & Hanya untuk Non-Siswa (Admin, Guru) -->
                                <!-- ========================================================================= -->
                                {% if request.user.role != 'SISWA' %}
                                <div class="pt-1">
                                    <p><strong>Tokens:</strong></p>
                                    <div class="flex flex-wrap gap-2 mt-1">
                                        {% for token_obj in exam.exam_tokens.all %}
                                        <div x-data="{ copied: false }" class="flex items-center">
                                            <span class="font-mono {% if token_obj.is_used %}bg-red-200 text-red-800 line-through{% else %}bg-gray-200 text-gray-800{% endif %} px-2 py-1 rounded-l-md">
                                                {{ token_obj.token }}
                                            </span>
                                            <button @click="
                                                navigator.clipboard.writeText('{{ token_obj.token }}').then(() => {
                                                    copied = true;
                                                    setTimeout(() => { copied = false }, 2000);
                                                });
                                            " class="text-xs bg-gray-300 hover:bg-gray-400 text-gray-800 px-2 py-1 rounded-r-md">
                                                <span x-show="!copied"><i class="ph ph-copy"></i></span>
                                                <span x-show="copied" class="text-green-600 font-semibold"><i class="ph ph-check"></i></span>
                                            </button>
                                        </div>
                                        {% empty %}
                                        <span class="text-xs text-gray-400">Tidak ada token.</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                <!-- --- AKHIR DARI PERUBAHAN --- -->
                            </div>
                            
                            <div class="mt-4 pt-3 border-t flex justify-between items-center">
                                {% if request.user.role != 'SISWA' %}
                                <a href="{% url 'class_student_list' exam.class_group.pk %}" class="text-sm font-semibold text-gray-600 hover:text-indigo-600 hover:underline" title="Lihat Daftar Peserta Kelas">
                                <i class="ph ph-users"></i>
                                 {{ exam.completed_attempts_count }} / {{ exam.total_students_in_class_count }} Selesai
                                 </a>
                                {% else %}
                                <div></div> <!-- Sisakan div kosong agar layout tidak berantakan -->
                                {% endif %}
                                <div class="flex space-x-2">
                                    {% if request.user.role == 'SISWA' %}
                                        {% get_exam_status exam as status %}
                                        {% if status == "SELESAI" %}
                                            <span class="bg-gray-400 text-white px-3 py-1 rounded text-xs cursor-not-allowed">Selesai</span>
                                        {% elif status == "BELUM_MULAI" %}
                                            <span class="bg-yellow-400 text-white px-3 py-1 rounded text-xs cursor-not-allowed" title="Ujian akan dimulai pada {{ exam.start_time|date:'d M Y, H:i' }}">Belum Mulai</span>
                                        {% elif status == "BERLANGSUNG" %}
                                            <a href="{% url 'exam_token_gate' exam.pk %}" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs">Kerjakan</a>
                                        {% elif status == "BERAKHIR" %}
                                            <span class="bg-red-400 text-white px-3 py-1 rounded text-xs cursor-not-allowed">Berakhir</span>
                                        {% endif %}
                                    {% else %}
                                        <a href="{% url 'exam_detail' exam.pk %}" class="text-blue-600 hover:text-blue-800 text-sm">Detail</a>
                                        <a href="{% url 'exam_edit' exam.pk %}" class="text-indigo-600 hover:text-indigo-900 text-sm">Edit</a>
                                        <a href="{% url 'exam_delete' exam.pk %}" class="text-red-600 hover:text-red-900 text-sm">Hapus</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% empty %}
                <p class="text-center text-gray-500 py-10">Belum ada ujian yang dibuat.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
